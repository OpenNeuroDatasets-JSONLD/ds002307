Resting state fMRI and dMRI data acquired on a cohort of 19 male F1 B6/129P mice (9-12 weeks).


#Here it is the code used to process dMRI data within 
#the Mrtrix3 software (Tournier, J. D., Calamante, F., & Connelly, A. (2012). MRtrix: diffusion tractography in crossing fiber regions. International journal of imaging systems and technology, 22(1), 53-66.) 
#in order to obtain the dMRI-based connectomes used in the article


#!/bin/bash

# paths
export FSLDIR=/usr/local/fsl
export FSLOUTPUTTYPE=NIFTI_GZ
source /soft/gcc492/activate
export PATH=$FSLDIR/bin:/soft/mrtrix3/bin:/soft/mrtrix3/scripts:$PATH
source /soft/mrtrix3-0.3.15/activate

# script starts
t1=/home/francesca/ElaboratingDiffusionData/Ey125
dir_in=$t1/input
dir_out=$t1/output
nthreads=8

# convert .nii.gz files in a format suitable for Mrtrix3
# Ey125_DTI.nii.gz file containing dMRI images of mouse Ey125
# Ey125_mask.nii.gz file mask image of the brain of mouse Ey125
mrconvert $dir_in/Ey125_DTI.nii.gz $dir_out/dwi.mif -fslgrad $dir_in/Bvec $dir_in/Bval 
mrconvert $dir_in/Ey125_mask.nii.gz $dir_out/mask.mif

#### Local model (calculate tracts for each voxel)
#data-->response
dwi2response tournier -nthreads $nthreads -mask $dir_out/mask.mif $dir_out/dwi.mif $dir_out/response.txt
#response--> fod
dwi2fod csd -nthreads $nthreads $dir_out/dwi.mif $dir_out/response.txt $dir_out/csd.mif -mask $dir_out/mask.mif


#### Global model (put together tracts of each voxel in order to obtain continuous tracts)
# tracking using mask as seed and deterministic tractography
tckgen -algorithm SD_Stream $dir_out/csd.mif $dir_out/Ey125_track_det_100M.tck -seed_image $dir_out/mask.mif -mask $dir_out/mask.mif -number 100M

# in alternative it is possible to use probabilistic tractography as:
tckgen $dir_out/csd.mif $dir_out/Ey125_track_prob_100M.tck -seed_image $dir_out/mask.mif -mask $dir_out/mask.mif -number 100M

#decrease number of tracts for visualization purpose (if not the file can not be load in mrview, too big)
tckedit $dir_out/Ey125_track_det.tck $dir_out/Ey125_track_det_smaller.tck -number 50000

# SIFT (Spherical Deconvolution Informed Filtering Tractograms) filter the number of 
#tracks according to the information of the the fod
tcksift $dir_out/Ey125_track_det.tck $dir_out/csd.mif $dir_out/Ey125_track_det_sift.tck

#Generate the connectome
# Vol_Allen.nii is an image of the mouse brain, aligned with the images of Ey125, 
# that encodes the parcellation used here
mrconvert $dir_in/Vol_Allen_Ey125.nii $dir_out/Vol_Allen_Ey125.mif

tck2connectome $dir_out/Ey125_track_det_sift.tck $dir_out/Vol_Allen_Ey125.mif $dir_out/Ey125_det.csv -assignment_radial_search 1 -scale_invnodevol

